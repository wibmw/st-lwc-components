<template>
    <div class="slds-box slds-box_small slds-theme_default main-container slds-is-relative">
        
        <template if:true={isLoading}>
            <lightning-spinner alternative-text="Chargement..." size="medium" variant="brand"></lightning-spinner>
        </template>

        <div class="slds-grid slds-gutters slds-wrap slds-page-header slds-m-bottom_medium header-container">
            <div class="slds-col slds-size_1-of-1 slds-medium-size_8-of-12">
                <div class="slds-media">
                    <div class="slds-media__figure">
                        <lightning-icon icon-name="standard:shipment" alternative-text="Logistique"></lightning-icon>
                    </div>
                    <div class="slds-media__body">
                        <h1 class="slds-page-header__title slds-truncate" title={cardTitle}>{cardTitle}</h1>
                    </div>
                </div>
            </div>
            
            <div class="slds-col slds-size_1-of-1 slds-medium-size_4-of-12 slds-text-align_right actions-container">
                 </div>
        </div>

        <div class="slds-grid slds-wrap slds-gutters_medium slds-p-horizontal_medium slds-p-bottom_medium">
            
            <div class="slds-col slds-size_1-of-1 slds-m-bottom_medium">
                <div class="slds-box slds-box_small slds-theme_shade h-100">
                    <div class="responsive-padding slds-p-bottom_medium">                      
                             <div class="slds-grid slds-wrap slds-gutters slds-m-bottom_small">
                                <div class="slds-col slds-size_1-of-1 slds-medium-size_3-of-12 slds-m-bottom_small">
                                    <div class="slds-form-element">
                                        <label class="slds-form-element__label" for="user-combobox">Demandeur</label>
                                        <div class="slds-form-element__control">
                                            <div class={userComboboxClass} aria-expanded={isLookupOpen.user} aria-haspopup="listbox" role="combobox">
                                                <div class="slds-combobox__form-element slds-input-has-icon slds-input-has-icon_right" role="none">
                                                    <template if:true={selectedDemandeur}>
                                                        <lightning-pill label={selectedDemandeur.label} onremove={handleLookupPillRemove} data-lookup="user" class="slds-size_1-of-1">
                                                            <lightning-icon icon-name="standard:user" alternative-text="User"></lightning-icon>
                                                        </lightning-pill>
                                                    </template>
                                                    <template if:false={selectedDemandeur}>
                                                        <lightning-input type="search" variant="label-hidden" label="Recherche Demandeur" placeholder="Rechercher..." onchange={handleLookupSearch} onfocus={handleLookupFocus} onblur={handleLookupBlur} data-lookup="user" disabled={isReadOnly}></lightning-input>
                                                    </template>
                                                </div>
                                                <div class="slds-dropdown slds-dropdown_fluid" role="listbox">
                                                    <ul class="slds-listbox slds-listbox_vertical" role="presentation">
                                                        <template for:each={lookupSuggestions.user} for:item="suggestion">
                                                            <li key={suggestion.value} role="presentation" class="slds-listbox__item">
                                                                <div class="slds-media slds-listbox__option slds-listbox__option_entity slds-listbox__option_has-meta" role="option" onclick={handleLookupSelect} data-value={suggestion.value} data-label={suggestion.label} data-lookup="user">
                                                                    <span class="slds-media__figure slds-listbox__option-icon">
                                                                        <lightning-icon icon-name="standard:user" size="small"></lightning-icon>
                                                                    </span>
                                                                    <span class="slds-media__body">
                                                                        <span class="slds-listbox__option-text">{suggestion.label}</span>
                                                                    </span>
                                                                </div>
                                                            </li>
                                                        </template>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="slds-col slds-size_1-of-1 slds-medium-size_3-of-12 slds-m-bottom_small">
                                    <lightning-input type="text" label="Créé par" value={createdBy} disabled variant="label-stacked"></lightning-input>
                                </div>
                                <div class="slds-col slds-size_1-of-1 slds-medium-size_3-of-12 slds-m-bottom_small">
                                    <lightning-combobox label="Type de Réception" value={typeReception} options={typeReceptionOptions} onchange={handleTypeReceptionChange} variant="label-stacked" disabled></lightning-combobox>
                                </div>
                                <div class="slds-col slds-size_1-of-1 slds-medium-size_3-of-12 slds-m-bottom_small">
                                    <lightning-combobox label="Transporteur" value={typeTransporteur} options={typeTransporteurOptions} onchange={handleTypeTransporteurChange} variant="label-stacked" disabled={isReadOnly}></lightning-combobox>
                                </div>

                                <div class="slds-col slds-size_1-of-1 slds-medium-size_3-of-12 slds-m-bottom_small">
                                     <div class="slds-form-element">
                                        <label class="slds-form-element__label" for="stock-combobox">Réparateur</label>
                                        <div class="slds-form-element__control">
                                                 <div class={stockComboboxClass} aria-expanded={isLookupOpen.stock} aria-haspopup="listbox" role="combobox">
                                                    <div class="slds-combobox__form-element slds-input-has-icon slds-input-has-icon_right" role="none">
                                                        <template if:true={selectedStock}>
                                                            <lightning-pill label={selectedStock.label} onremove={handleLookupPillRemove} data-lookup="stock" class="slds-size_1-of-1">
                                                                <lightning-icon icon-name="standard:location" alternative-text="Site"></lightning-icon>
                                                            </lightning-pill>
                                                        </template>
                                                         <template if:false={selectedStock}>
                                                            <lightning-input type="search" variant="label-hidden" label="Recherche Site" placeholder="Rechercher..." onchange={handleLookupSearch} onfocus={handleLookupFocus} onblur={handleLookupBlur} data-lookup="stock" disabled={isReadOnly}></lightning-input>
                                                        </template>
                                                    </div>
                                                     <div class="slds-dropdown slds-dropdown_fluid" role="listbox">
                                                        <ul class="slds-listbox slds-listbox_vertical" role="presentation">
                                                            <template for:each={lookupSuggestions.stock} for:item="suggestion">
                                                                <li key={suggestion.value} role="presentation" class="slds-listbox__item">
                                                                    <div class="slds-media slds-listbox__option slds-listbox__option_entity slds-listbox__option_has-meta" role="option" onclick={handleLookupSelect} data-value={suggestion.value} data-label={suggestion.label} data-sublabel={suggestion.subLabel} data-lookup="stock">
                                                                        <span class="slds-media__figure slds-listbox__option-icon">
                                                                            <lightning-icon icon-name="standard:location" size="small"></lightning-icon>
                                                                        </span>
                                                                        <span class="slds-media__body">
                                                                            <span class="slds-listbox__option-text">{suggestion.label}</span>
                                                                             <span class="slds-listbox__option-meta">{suggestion.subLabel}</span>
                                                                        </span>
                                                                    </div>
                                                                </li>
                                                            </template>
                                                        </ul>
                                                    </div>
                                                 </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="slds-col slds-size_1-of-1 slds-medium-size_3-of-12 slds-m-bottom_small">
                                    <lightning-combobox label="Type d'envoi" value={typeEnvoi} options={typeOptions} onchange={handleTypeChange} variant="label-stacked" disabled></lightning-combobox>
                                </div>
                                
                                <template if:false={isMainPropre}>
                                    <div class="slds-col slds-size_1-of-1 slds-medium-size_3-of-12 slds-m-bottom_small">
                                        <div class="slds-form-element">
                                            <label class="slds-form-element__label" for="destinataire-combobox">Contact du Réparateur</label>
                                            <div class="slds-form-element__control">
                                                <div id="destinataire-combobox" class={destinataireComboboxClass} aria-expanded={isLookupOpen.destinataire} aria-haspopup="listbox" role="combobox">
                                                    <div class="slds-combobox__form-element slds-input-has-icon slds-input-has-icon_right" role="none">
                                                        <template if:true={selectedDestinataire}>
                                                            <lightning-pill label={selectedDestinataire.label} onremove={handleLookupPillRemove} data-lookup="destinataire" class="slds-size_1-of-1">
                                                                <lightning-icon icon-name="standard:contact" alternative-text="Contact"></lightning-icon>
                                                            </lightning-pill>
                                                        </template>
                                                        <template if:false={selectedDestinataire}>
                                                            <lightning-input type="search" variant="label-hidden" placeholder="Rechercher..." onchange={handleLookupSearch} onfocus={handleLookupFocus} onblur={handleLookupBlur} data-lookup="destinataire" disabled={isReadOnly}></lightning-input>
                                                        </template>
                                                    </div>
                                                    <div class="slds-dropdown slds-dropdown_fluid" role="listbox">
                                                        <ul class="slds-listbox slds-listbox_vertical" role="presentation">
                                                            <template for:each={lookupSuggestions.destinataire} for:item="suggestion">
                                                                <li key={suggestion.value} role="presentation" class="slds-listbox__item">
                                                                    <div class="slds-media slds-listbox__option slds-listbox__option_entity slds-listbox__option_has-meta" role="option" onclick={handleLookupSelect} data-value={suggestion.value} data-label={suggestion.label} data-sublabel={suggestion.sublabel} data-lookup="destinataire" data-address={suggestion.address}>
                                                                        <span class="slds-media__figure slds-listbox__option-icon">
                                                                            <lightning-icon icon-name="standard:contact" size="small"></lightning-icon>
                                                                        </span>
                                                                        <span class="slds-media__body">
                                                                            <span class="slds-listbox__option-text">{suggestion.label}</span>
                                                                            <span class="slds-listbox__option-meta">{suggestion.sublabel}</span>
                                                                        </span>
                                                                    </div>
                                                                </li>
                                                            </template>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="slds-col slds-size_1-of-1 slds-medium-size_3-of-12 slds-m-bottom_small">
                                        <lightning-textarea label="Adresse de Livraison" value={contactAddress} readonly class="address-textarea"></lightning-textarea>
                                    </div>
                                </template>
                            </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="slds-grid slds-wrap slds-gutters_medium slds-p-horizontal_medium slds-p-bottom_medium">
             <div class="slds-col slds-size_1-of-1 slds-large-size_5-of-12 slds-m-bottom_medium">
                 <div class="slds-box slds-box_small slds-theme_shade h-100">
                    <h2 class="slds-text-heading_medium slds-m-bottom_medium">Pièces disponibles pour le même Réparateur</h2>

                     <div class="slds-scrollable_y scroll-container">
                        <template if:true={filteredSearchResults.length}>
                            <template for:each={filteredSearchResults} for:item="result">
                                <div key={result.id} class="slds-box slds-box_xx-small slds-theme_default slds-m-bottom_xx-small border-left-blue">
                                    <div class="slds-grid slds-grid_align-spread">
                                        <span class="slds-text-title_bold" title={result.name} style="padding-left: 0;">{result.name}-{result.cleEquipement}</span>
                                        <span class="slds-text-body_small slds-truncate slds-m-left_small" title={result.mnemonique} style="padding-right: 10px;">{result.mnemonique}</span>
                                    </div>
                                    <div class="slds-grid slds-grid_align-spread slds-m-top_xx-small">
                                        <div class="slds-truncate" title={result.description} style="max-width: 65%; padding-left: 0;">
                                            <template if:true={result.rma}>
                                                <span class="slds-text-body_small slds-text-color_weak text-true-royal">{result.rma}</span>
                                            </template>
                                        </div>
                                        <div class="slds-truncate slds-text-align_right" title="N° Série" style="max-width: 35%;">
                                            <span class="slds-text-body_small slds-text-color_weak text-true-royal" style="padding-right: 10px;">{result.nSerie}</span>
                                        </div>
                                    </div>

                                    <div class="slds-grid slds-grid_align-spread slds-grid_vertical-align-center slds-m-top_xx-small">
                                        <div class="slds-text-body_small slds-text-color_weak slds-truncate" style="max-width: 80%; padding-left: 0;">
                                            <span class="slds-text-body_small slds-text-color_weak">{result.description}</span>
                                       </div> 
                                        <lightning-button-icon 
                                            icon-name="utility:add" 
                                            variant="brand" 
                                            size="small" 
                                            data-id={result.id} 
                                            onclick={handleAddToCart} 
                                            alternative-text="Ajouter"
                                            disabled={isReadOnly}
                                            style="padding-right: 10px;">
                                        </lightning-button-icon>
                                    </div>
                                </div>
                            </template>
                        </template>
                        
                        <template if:true={isSearching}>
                            <div class="slds-align_absolute-center slds-m-top_medium">
                                <lightning-spinner size="small" alternative-text="Recherche..."></lightning-spinner>
                            </div>
                        </template>
                        
                        <template if:false={filteredSearchResults.length}>
                            <template if:false={isSearching}>
                                <div class="slds-align_absolute-center slds-m-top_medium slds-text-align_center">
                                    <p class="slds-text-body_small slds-text-color_weak">Aucun résultat.</p>
                                </div>
                            </template>
                        </template>
                    </div>
                 </div>
             </div>

             <div class="slds-col slds-size_1-of-1 slds-large-size_7-of-12">
                 <div class="slds-box slds-box_small slds-theme_shade h-100">
                    <h2 class="slds-text-heading_medium slds-m-bottom_medium">Pièces sélectionnées</h2>
                    
                    <div class="slds-scrollable_y scroll-container-large">
                        <template if:true={cart.length}>
                            <template for:each={cartData} for:item="item">
                                <div key={item.pieceUnitaireId} class="slds-box slds-box_xx-small slds-theme_default slds-m-bottom_xx-small border-left-blue">
                                          
                                    <div class="slds-grid">
                                        <div class="slds-col" style="border-right: 1px solid #dddbda; padding-right: 10px;">
                                            <div class="slds-grid slds-grid_align-spread slds-m-bottom_x-small">
                                                <div class="slds-col slds-truncate slds-text-align_left" title={item.name} style="max-width: 40%; padding-left:0;"><strong>{item.name}-{item.cleEquipement}</strong></div>
                                                <div class="slds-col slds-truncate slds-text-align_center slds-text-body_small slds-text-color_weak" style="max-width: 30%;">{item.mnemonique}</div>
                                                <div class="slds-col slds-truncate slds-text-align_right slds-text-body_small text-true-royal" style="max-width: 30%; padding-right:10px;">{item.nSerie}</div>
                                            </div>

                                            <div class="slds-grid slds-grid_align-spread">
                                                <div class="slds-col slds-text-align_left" style="max-width: 40%; padding-left:0;">
                                                    <div class="slds-grid slds-grid_vertical-align-center slds-gutters_xx-small">
                                                        <div class="slds-grow">
                                                            <lightning-input 
                                                                type="text" 
                                                                label="N° Bon Livraison"
                                                                variant="label-hidden" 
                                                                placeholder="N° Bon Livraison" 
                                                                value={item.numBonLivraison} 
                                                                data-id={item.pieceUnitaireId}
                                                                data-field="numBonLivraison"
                                                                onchange={handleCartInputChange}
                                                                disabled={isBlReadOnly}
                                                                required
                                                                message-when-value-missing="Le N° Bon Livraison est obligatoire">
                                                            </lightning-input>
                                                        </div>
                                                        <div class="slds-col slds-shrink-none">
                                                            <template if:false={item.isTrackingDisabled}>
                                                                <lightning-button-icon 
                                                                    icon-name="utility:new_window" 
                                                                    variant="border-filled" 
                                                                    alternative-text="Suivre" 
                                                                    title="Suivre"
                                                                    data-url={item.trackingUrl}
                                                                    onclick={handleTrackItem}
                                                                    size="small">
                                                                </lightning-button-icon>
                                                            </template>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="slds-col slds-truncate slds-text-align_center slds-text-body_small slds-text-color_weak" style="max-width: 30%;"><template if:true={isChronopost}>{item.statutChronopost}</template></div>
                                                <div class="slds-col slds-truncate slds-text-align_right slds-text-body_small text-true-royal" style="max-width: 30%; padding-right:10px;">{item.rma}</div>
                                            </div>
                                        </div>

                                        <div class="slds-col slds-shrink-none slds-grid slds-grid_vertical slds-grid_align-center slds-grid_vertical-align-center" style="width: 5%; max-width: 5%; padding-left:0; padding-right:0;">
                                            <template if:true={isChronopost}>
                                                <lightning-button-icon icon-name="utility:success" variant="bare" alternative-text="Livré" title="Livré" class="slds-icon-text-success" size="large" onclick={handleChronopostAction} data-id={item.pieceUnitaireId} data-action="Livré" disabled={isReadOnly}></lightning-button-icon>
                                                <lightning-button-icon icon-name="utility:clear" variant="bare" alternative-text="Perdu" title="Perdu" class="slds-icon-text-error" size="large" onclick={handleChronopostAction} data-id={item.pieceUnitaireId} data-action="Perdu" disabled={isReadOnly}></lightning-button-icon>
                                            </template>
                                            <lightning-button-icon icon-name="utility:delete" variant="bare" alternative-text="Supprimer" title="Supprimer" class="slds-icon-text-error" size="medium" onclick={handleRemoveFromCart} data-id={item.pieceUnitaireId} disabled={isReadOnly}></lightning-button-icon>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </template>
                        <template if:false={cart.length}>
                             <div class="slds-align_absolute-center slds-p-vertical_medium slds-text-color_weak">Panier vide</div>
                        </template>
                    </div>
                 </div>
             </div>
        </div>

        <div class="sticky-footer slds-text-align_right">
             <template if:true={hasCommandeDetails}>
                <div class="slds-button-group" role="group">
                    <lightning-button 
                        label="Refuser la Commande" 
                        variant="destructive" 
                        onclick={handleSave} 
                        data-global-action="REFUSER"
                        disabled={isRefuseDisabled} 
                        class="slds-m-right_x-small">
                    </lightning-button>
                    
                    <lightning-button 
                        label={validateButtonLabel}
                        variant={validateButtonVariant}
                        onclick={handleSave} 
                        data-global-action="VALIDER"
                        disabled={isValidateDisabled}>
                    </lightning-button>
                </div>
             </template>
             <template if:false={hasCommandeDetails}>
                <lightning-button label={saveButtonLabel} variant="brand" onclick={handleSave} disabled={isSaveDisabled}></lightning-button>
             </template>
        </div>
    </div>
</template>