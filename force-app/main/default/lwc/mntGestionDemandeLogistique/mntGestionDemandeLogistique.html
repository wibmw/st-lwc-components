<template>
    <template if:true={showSuccessMessage}>
        <div class="success-overlay">
            <div class="success-card">
                <div class="success-icon-container">
                    <lightning-icon icon-name="action:approval" alternative-text="Succès" size="large"></lightning-icon>
                </div>
                <div class="success-text">Demande créée avec succès !</div>
            </div>
        </div>
    </template>
  <lightning-card title={cardTitle} icon-name="utility:cart">
      <div slot="actions">
        <template if:true={isDesktop}>
            <lightning-button-group>
                <lightning-button label="PEC Cockpit" name="pec_cockpit" onclick={handlePecAction} disabled={isPecCockpitDisabled}></lightning-button>
                <lightning-button label="PEC Retraitement" name="pec_retraitement" onclick={handlePecAction} disabled={isPecRetraitementDisabled}></lightning-button>
            </lightning-button-group>
        </template>
      </div>

      <!-- ======================= SECTION D'EN-TÊTE AVEC LES 4 CHAMPS ======================= -->

      <!-- ============== DESKTOP ================== -->
       <template if:true={isViewCommandInfo}>
        <template if:true={isDesktop}>
            <div class="slds-p-horizontal_medium slds-p-bottom_medium slds-border_bottom">
                <div class="slds-grid slds-wrap slds-gutters">
                    <!-- COLONNE GAUCHE : INFORMATIONS COMMANDE -->
                    <div class="slds-col slds-size_1-of-1 slds-large-size_12-of-12">
                        <h2 class="slds-text-heading_medium slds-m-bottom_medium">Informations de la Demande</h2>
                        
                        <lightning-accordion allow-multiple-sections-open active-section-name={activeSections} class="accordion-themed">
                            
                            <!-- SECTION 1 : INFORMATION DEMANDE -->
                            <lightning-accordion-section name="info_demande" label="Information Demande">
                                <div class="slds-grid slds-wrap slds-gutters">
                                    
                                    <!-- Ligne 1 : N° Ticket Correctif et Compte Projet -->
                                    <div class="slds-col slds-size_1-of-2">
                                        <c-lookup-pill
                                            label="N° Ticket Correctif"
                                            placeholder="Rechercher un ticket..."
                                            icon-name="standard:case"
                                            s-object-type="Correctif__c"
                                            controller-name="demande"
                                            selected-value={selectedNTicket}
                                            onselect={handleLookupSelect}
                                            onremove={handleLookupRemove}
                                            data-lookup="ticket">
                                        </c-lookup-pill>
                                    </div>
                                    <div class="slds-col slds-size_1-of-2">
                                        <lightning-input type="text" label="Compte Projet" value={compteProjet} onchange={handleCompteProjetChange} placeholder="Saisir compte projet..." variant="label-stacked"></lightning-input>
                                    </div>

                                    <!-- Ligne 2 : Demandeur et Créé par -->
                                    <div class="slds-col slds-size_1-of-2">
                                        <c-lookup-pill
                                            label="Demandeur"
                                            placeholder="Rechercher un demandeur..."
                                            icon-name="standard:user"
                                            s-object-type="User"
                                            controller-name="demande"
                                            selected-value={selectedDemandeur}
                                            onselect={handleLookupSelect}
                                            onremove={handleLookupRemove}
                                            data-lookup="demandeur">
                                        </c-lookup-pill>
                                    </div>
                                    <div class="slds-col slds-size_1-of-2">
                                        <lightning-input type="text" label="Créé Par" value={createdByName} readonly variant="label-stacked"></lightning-input>
                                    </div>

                                    <!-- Ligne 3 : Lieu et Type de Réception -->
                                    <div class="slds-col slds-size_1-of-2">
                                        <c-lookup-pill
                                            label="Lieu de Destination"
                                            placeholder="Rechercher un site..."
                                            icon-name="standard:location"
                                            s-object-type="sitetracker__Site__c"
                                            controller-name="demande"
                                            selected-value={selectedLieu}
                                            onselect={handleLookupSelect}
                                            onremove={handleLookupRemove}
                                            data-lookup="lieu">
                                        </c-lookup-pill>
                                    </div>
                                    <div class="slds-col slds-size_1-of-2">
                                        <lightning-combobox label="Type de Réception" value={typeReception} options={typeReceptionOptions} onchange={handleTypeReceptionChange} variant="label-stacked"></lightning-combobox>
                                    </div>

                                    <!-- Ligne 4 : Adresse de Livraison et Adresse détaillée -->
                                    <template if:true={showAddressFields}>
                                        <div class="slds-col slds-size_1-of-2">
                                            <c-lookup-pill
                                                label="Adresse de Livraison"
                                                placeholder="Rechercher une adresse..."
                                                icon-name="standard:address"
                                                s-object-type="Contact"
                                                controller-name="demande"
                                                selected-value={selectedAdresseLivraison}
                                                onselect={handleLookupSelect}
                                                onremove={handleLookupRemove}
                                                data-lookup="adresseLivraison">
                                            </c-lookup-pill>
                                        </div>
                                        <div class="slds-col slds-size_1-of-2">
                                            <lightning-textarea label="Adresse détaillée" value={contactAddress} readonly variant="label-stacked"></lightning-textarea>
                                        </div>
                                    </template>

                                    <!-- Ligne 5 : Commentaire -->
                                    <div class="slds-col slds-size_1-of-1">
                                        <lightning-textarea label="Commentaire" value={globalComment} placeholder="Saisir un commentaire..." variant="label-stacked" onchange={handleGlobalCommentChange}></lightning-textarea>
                                    </div>
                                </div>
                            </lightning-accordion-section>

                            <!-- SECTION 2 : INFORMATION DU TICKET -->
                            <lightning-accordion-section name="info_ticket" label="Information du Ticket">
                                <div class="slds-grid slds-wrap slds-gutters">
                                    <!-- Ligne 1 : G2R et Nom du site -->
                                    <div class="slds-col slds-size_1-of-2">
                                        <lightning-input type="text" label="G2R" value={g2r} readonly variant="label-stacked"></lightning-input>
                                    </div>
                                    <div class="slds-col slds-size_1-of-2">
                                        <lightning-input type="text" label="Nom du site" value={siteName} readonly variant="label-stacked"></lightning-input>
                                    </div>
                                    <!-- Ligne 2 : Priorité Ticket et Statut Ticket -->
                                    <div class="slds-col slds-size_1-of-2">
                                        <lightning-input type="text" label="Priorité du Ticket" value={ticketPriority} readonly variant="label-stacked"></lightning-input>
                                    </div>
                                    <div class="slds-col slds-size_1-of-2">
                                        <lightning-input type="text" label="Statut du Ticket" value={ticketStatus} readonly variant="label-stacked"></lightning-input>
                                    </div>
                                </div>
                            </lightning-accordion-section>

                            <!-- SECTION 3 : PEC COCKPIT -->
                            <lightning-accordion-section name="pec_cockpit" label="PEC Cockpit">
                                <div class="slds-grid slds-wrap slds-gutters">
                                    <!-- Ligne 1 : Date PEC Cockpit et PEC Par -->
                                    <div class="slds-col slds-size_1-of-2">
                                        <lightning-input type="text" label="PEC Par" value={pecCockpitBy} readonly variant="label-stacked"></lightning-input>
                                    </div>
                                    <div class="slds-col slds-size_1-of-2">
                                        <label class="slds-form-element__label">Date PEC Cockpit</label>
                                        <lightning-input type="datetime" variant="label-hidden" value={pecCockpitDate} disabled></lightning-input>
                                    </div>
                                    <!-- Ligne 2 : Date Retraitement et Retraitement Par -->
                                    <div class="slds-col slds-size_1-of-2">
                                        <lightning-input type="text" label="Retraitement Par" value={pecRetraitementBy} readonly variant="label-stacked"></lightning-input>
                                    </div>
                                    <div class="slds-col slds-size_1-of-2">
                                        <label class="slds-form-element__label">Date Retraitement</label>
                                        <lightning-input type="datetime" variant="label-hidden" value={pecRetraitementDate} disabled></lightning-input>
                                    </div>
                                </div>
                            </lightning-accordion-section>
                        </lightning-accordion>
                </div>
            </div>
            </div>
        </template>

      </template>
      <!-- ============== MOBILE ================== -->
       <template if:false={isDesktop}>
            <div class="slds-p-horizontal_medium slds-p-bottom_medium slds-border_bottom">
                <div class="slds-grid slds-wrap slds-gutters">
                    <!-- COLONNE GAUCHE : INFORMATIONS COMMANDE -->
                    <div class="slds-col slds-size_1-of-1 slds-large-size_12-of-12">
                        <h2 class="slds-text-heading_medium slds-m-bottom_medium">Informations de la Demande</h2>
                        <lightning-layout multiple-rows="true">
                    
                        <!-- N° TICKET  -->
                        <lightning-layout-item size="12" padding="around-small">
                             <div class="slds-grid slds-wrap slds-gutters">
                                <template if:true={showMobileTicketLookup}>
                                    <div class="slds-col slds-size_1-of-1 slds-m-bottom_small">
                                        <c-lookup-pill
                                            label="N° Ticket Correctif"
                                            placeholder="Rechercher un ticket..."
                                            icon-name="standard:case"
                                            s-object-type="Correctif__c"
                                            controller-name="demande"
                                            selected-value={selectedNTicket}
                                            onselect={handleLookupSelect}
                                            onremove={handleLookupRemove}
                                            data-lookup="ticket">
                                        </c-lookup-pill>
                                    </div>
                                </template>
                                <template if:false={showMobileTicketLookup}>
                                    <div class="slds-col slds-size_1-of-2">
                                        <lightning-input type="text" label="N° Ticket" value={ticketName} disabled variant="label-stacked"></lightning-input>
                                    </div>
                                </template>

                                <!-- Ces champs s'affichent toujours (soit pré-remplis par lookup, soit par contexte) -->
                                <div class="slds-col slds-size_1-of-2">
                                    <lightning-input type="text" label="G2R" value={g2r} disabled variant="label-stacked"></lightning-input>
                                </div>
                                <div class="slds-col slds-size_1-of-1">
                                    <lightning-input type="text" label="Nom du Site" value={siteName} disabled variant="label-stacked"></lightning-input>
                                </div>
                            </div>
                        </lightning-layout-item>

                        <!-- DEMANDEUR -->
                        <lightning-layout-item size="12" padding="around-small">
                            <c-lookup-pill
                                label="Demandeur"
                                icon-name="standard:user"
                                s-object-type="User"
                                controller-name="demande"
                                selected-value={selectedDemandeur}
                                onselect={handleLookupSelect}
                                onremove={handleLookupRemove}
                                data-lookup="demandeur"
                                disabled
                            ></c-lookup-pill>
                        </lightning-layout-item>

                        <!-- LIEU -->
                        <lightning-layout-item size="12" padding="around-small">
                            <c-lookup-pill
                                label="Lieu de Destination"
                                icon-name="standard:account"
                                s-object-type="sitetracker__Site__c"
                                controller-name="demande"
                                selected-value={selectedLieu}
                                onselect={handleLookupSelect}
                                onremove={handleLookupRemove}
                                data-lookup="lieu"
                            ></c-lookup-pill>
                        </lightning-layout-item>

                        <!-- COMPTE PROJET -->
                        <lightning-layout-item size="12" padding="around-small">
                            <lightning-input 
                                type="text" 
                                label="Compte Projet" 
                                value={compteProjet} 
                                onchange={handleCompteProjetChange}
                                disabled
                                variant="label-stacked">
                            </lightning-input>
                        </lightning-layout-item>

                        <!-- TYPE RECEPTION -->
                        <lightning-layout-item size="12" padding="around-small">
                            <lightning-combobox 
                                label="Type de Réception" 
                                value={typeReception} 
                                options={typeReceptionOptions} 
                                onchange={handleTypeReceptionChange}
                                variant="label-stacked">
                            </lightning-combobox>
                        </lightning-layout-item>

                        <!-- ADRESSE LIVRAISON -->
                        <template if:true={showAddressFields}>
                            <lightning-layout-item size="12" padding="around-small">
                                <c-lookup-pill
                                    label="Adresse de Livraison"
                                    icon-name="standard:contact"
                                    s-object-type="Contact"
                                    controller-name="demande"
                                    selected-value={selectedAdresseLivraison}
                                    onselect={handleLookupSelect}
                                    onremove={handleLookupRemove}
                                    data-lookup="adresseLivraison"
                                ></c-lookup-pill>
                            </lightning-layout-item>

                            <!-- CONTACT ADDRESS -->
                            <lightning-layout-item size="12" padding="around-small">
                                <lightning-textarea 
                                    value={contactAddress} 
                                    readonly
                                    variant="label-hidden">
                                </lightning-textarea>
                            </lightning-layout-item>
                        </template>

                        <lightning-layout-item size="12" padding="around-small">
                            <lightning-textarea 
                                label="Commentaire" 
                                value={globalComment} 
                                onchange={handleGlobalCommentChange}
                                variant="label-stacked">
                            </lightning-textarea>
                        </lightning-layout-item>
                    
                        <lightning-layout-item size="12" medium-device-size="12" padding="around-small">
                        <div class="slds-form-element">
                            <label class="slds-form-element__label">Photos</label>
                            <div class="slds-form-element__control">
                                
                                <!-- MODE CRÉATION -->
                                <template if:false={isEditMode}>
                                    <div class="slds-grid slds-wrap slds-gutters">
                                        <div class="slds-col slds-size_1-of-1 slds-medium-size_3-of-12">
                                            <lightning-input type="file" label="Ajouter des photos" variant="label-hidden" multiple accept=".jpg, .jpeg, .png" onchange={handleFileSelect}></lightning-input>
                                        </div>
                                        <div class="slds-col slds-size_1-of-1 slds-medium-size_9-of-12">
                                            <template if:true={hasFilesToUpload}>
                                                <div class="slds-grid slds-wrap slds-gutters_x-small">
                                                    <template for:each={filesToUpload} for:item="file" for:index="index">
                                                        <div key={file.key} class="slds-col slds-size_1-of-4 slds-medium-size_1-of-6 slds-large-size_1-of-8 slds-m-bottom_small">
                                                            <div class="slds-box slds-box_x-small slds-theme_shade slds-text-align_center slds-position_relative">
                                                                <lightning-button-icon icon-name="utility:close" variant="bare" size="small" class="slds-position_absolute slds-float_right" style="top:0; right:0;" data-index={index} onclick={handleRemoveFileToUpload}></lightning-button-icon>
                                                                <img src={file.previewUrl} style="max-height: 50px; max-width: 100%;" />
                                                                <div class="slds-truncate slds-text-body_small" title={file.name}>{file.name}</div>
                                                            </div>
                                                        </div>
                                                    </template>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </template>

                                <!-- MODE ÉDITION -->
                                <template if:true={isEditMode}>
                                    <div class="slds-grid slds-wrap slds-gutters">
                                        <div class="slds-col slds-size_1-of-1 slds-medium-size_3-of-12">
                                            <lightning-file-upload
                                                label="Ajouter des photos"
                                                name="fileUploader"
                                                record-id={recordId}
                                                accept=".jpg, .jpeg, .png"
                                                multiple
                                                onuploadfinished={handleUploadFinished}>
                                            </lightning-file-upload>
                                        </div>
                                        <div class="slds-col slds-size_1-of-1 slds-medium-size_9-of-12">
                                            <template if:true={hasAttachedFiles}>
                                                <div class="slds-grid slds-wrap slds-gutters_x-small">
                                                    <template for:each={attachedFiles} for:item="file">
                                                        <div key={file.id} class="slds-col slds-size_1-of-4 slds-medium-size_1-of-6 slds-large-size_1-of-8 slds-m-bottom_small">
                                                            <div class="slds-box slds-box_x-small slds-theme_shade slds-text-align_center slds-p-around_none" style="position: relative;">
                                                                <lightning-button-icon icon-name="utility:close" variant="border-filled" size="small" class="delete-btn" style="position: absolute; top: 2px; right: 2px; z-index: 10;" data-id={file.id} onclick={handleDeleteAttachedFile}></lightning-button-icon>
                                                                <img src={file.previewUrl} style="width: 100%; height: 100px; object-fit: cover; display: block; cursor: pointer;" data-id={file.id} onclick={handlePreviewFile} />
                                                            </div>
                                                            <div class="slds-text-align_center slds-text-body_small slds-m-top_xx-small slds-truncate" title={file.title}>{file.title}</div>
                                                        </div>
                                                    </template>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </lightning-layout-item>
                </lightning-layout>
                </div>
            </div>
            </div>
       </template>


      <!-- ======================= CORPS DU COMPOSANT : DEUX COLONNES ======================= -->
      <div class="slds-grid slds-wrap slds-gutters_medium slds-p-around_medium">
          <!-- COLONNE DE GAUCHE : RECHERCHE ARTICLES -->
          <div class="slds-col slds-size_1-of-1 slds-large-size_5-of-12 slds-m-bottom_medium">
              <div class="slds-box slds-box_small slds-theme_shade">
                  <h2 class="slds-text-heading_medium slds-m-bottom_medium">Rechercher un Article</h2>
                  <div class="slds-form-element">
                      <div class="slds-combobox_container">
                          <div class="slds-combobox slds-dropdown-trigger slds-dropdown-trigger_click">
                              <div class="slds-combobox__form-element slds-input-has-icon slds-input-has-icon_right" role="none">
                                  <lightning-input type="search" id="article-search" label="Rechercher des articles" variant="label-hidden" value={articleSearchTerm} onchange={handleArticleSearchInput} placeholder="Rechercher... (min 3 lettres)"></lightning-input>
                              </div>
                          </div>
                      </div>
                  </div>
                  <div class="slds-m-top_medium">
                  <template if:true={isDesktop}>
                      <!-- Desktop Card View - Full width rows -->
                      <template for:each={enhancedRows} for:item="row">
                          <div key={row.key} class="slds-box slds-box_xx-small slds-theme_default slds-m-bottom_xx-small" style="border-left: 3px solid #0176d3; padding: 0.4rem 0.75rem;">
                              <!-- Line 1: Mnemonique left, Article right -->
                              <div class="slds-grid slds-grid_align-spread">
                                  <span class="slds-text-title_bold">{row.mnemonique}</span>
                                  <span class="slds-text-body_small">{row.articleName}</span>
                              </div>
                              <!-- Line 2: Site left, Stock + Button right -->
                              <div class="slds-grid slds-grid_align-spread slds-grid_vertical-align-center slds-m-top_xx-small">
                                  <span class="slds-text-body_small slds-text-color_weak">{row.siteName}</span>
                                  <div class="slds-grid slds-grid_vertical-align-center">
                                      <span class="slds-badge slds-badge_inverse slds-m-right_x-small" style="font-size: 0.65rem;">Stock: {row.stock}</span>
                                      <lightning-button-icon icon-name="utility:add" variant="brand" size="small" disabled={row.isAddedToCart} data-key={row.key} onclick={handleMobileAggAdd} alternative-text="Ajouter"></lightning-button-icon>
                                  </div>
                              </div>
                          </div>
                      </template>
                  </template>
                  <template if:false={isDesktop}>
                      <template for:each={enhancedRows} for:item="row">
                          <div key={row.key} class="mobile-card">
                              <div class="mobile-card-header">
                                  <div>
                                      <div class="mobile-card-title">{row.mnemonique}</div>
                                      <div class="mobile-card-subtitle">{row.articleName}</div>
                                  </div>
                              </div>
                              <div class="mobile-card-body">
                                  <p class="slds-text-body_small">{row.description}</p>
                              </div>
                              <div class="mobile-card-footer">
                                  <lightning-button label="Ajouter" variant="brand-outline" disabled={row.isAddedToCart} data-key={row.key} onclick={handleMobileAggAdd}></lightning-button>
                              </div>
                          </div>
                      </template>
                  </template>
                      <template if:true={showNoResultsMessage}>
                        <div class="slds-align_absolute-center">
                            <div class=" slds-m-top_large slds-text-align_center">
                                <h3 class="slds-text-heading_small">Aucun stock trouvé</h3><br/>
                                <p class="slds-text-body_regular">Essayez avec un autre terme de recherche.</p>
                            </div>
                        </div>
                    </template>
                  </div>
              </div>
          </div>

          <!-- COLONNE DE DROITE : PANIER -->
          <div class="slds-col slds-size_1-of-1 slds-large-size_7-of-12">
              <div class="slds-box slds-box_small slds-theme_shade">
                  <h2 class="slds-text-heading_medium slds-m-bottom_medium">Panier</h2>
                  <template if:true={cart.length}>
                    <template if:true={isDesktop}>
                        <div class="slds-scrollable_y" style="max-height: 500px;">
                            <template for:each={cart} for:item="item">
                                <div key={item.key} class="slds-box slds-box_xx-small slds-theme_default slds-m-bottom_xx-small border-left-blue">
                                    
                                    <div class="slds-grid">
                                        <div class="slds-col" style="border-right: 1px solid #dddbda; padding-right: 10px;">
                                            <!-- LIGNE 1: Mnémonique + Statut + Nom Article -->
                                            <div class="slds-grid slds-grid_align-spread slds-m-bottom_x-small">
                                                <div class="slds-col slds-truncate slds-text-align_left" title={item.mnemonique} style="width: 45%; padding-left:0;"><strong>{item.mnemonique}</strong></div>
                                                <div class="slds-col slds-truncate slds-text-align_center slds-text-body_small slds-text-color_weak" style="width: 35%;">{item.siteName}</div>
                                                <div class="slds-col slds-truncate slds-text-align_right slds-text-body_small" title={item.articleName} style="width: 20%; padding-right:10px;">{item.articleName}</div>
                                            </div>

                                            <!-- LIGNE 2: Site + Quantité -->
                                            <div class="slds-grid slds-grid_align-spread">
                                                <div class="slds-col slds-text-align_left slds-text-body_small slds-text-color_weak" style="width: 45%; padding-left:0;">                                                
                                                    <textarea
                                                        class="slds-textarea style-panier"
                                                        placeholder="Ajouter un commentaire..."
                                                        data-key={item.key}
                                                    >{item.comment}</textarea>
                                                </div>
                                                <div class="slds-col slds-text-align_center" style="width: 35%;">{item.statutForDisplay}</div>
                                                <div class="slds-col" style="width: 20%;">
                                                <div style="width: 40px; margin-left: auto; margin-right: -10px;">
                                                        <lightning-input 
                                                            type="number" 
                                                            variant="label-hidden" 
                                                            placeholder="Qté" 
                                                            value={item.quantity} 
                                                            data-key={item.key} 
                                                            onfocusout={handleMobileQuantityChange}
                                                            min="1" 
                                                            max={item.stock}>
                                                        </lightning-input>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="slds-col slds-shrink-none slds-grid slds-grid_vertical slds-grid_align-center slds-grid_vertical-align-center" style="width: 5%; max-width: 5%; padding-left:0; padding-right:0;">
                                            <lightning-button-icon 
                                                icon-name="utility:delete" 
                                                variant="bare" 
                                                alternative-text="Supprimer" 
                                                title="Supprimer" 
                                                class="slds-icon-text-error"
                                                size="medium"
                                                data-key={item.key} 
                                                onclick={handleCartRemove}>
                                            </lightning-button-icon>
                                        </div>
                                    </div>

                                </div>
                            </template>
                        </div>
                    </template>
                      <!--template if:true={isDesktop}>
                          <lightning-datatable class="datatable-with-scroll" data-id="cart" key-field="key" data={cart} columns={cartCols} hide-checkbox-column onsave={handleCartSave} onrowaction={handleCartAction}></lightning-datatable>
                      </template-->
                      <template if:false={isDesktop}>
                          <template for:each={cart} for:item="item">
                              <div key={item.key} class="mobile-card">
                                  <div class="mobile-card-header">
                                      <div>
                                          <div class="mobile-card-title">{item.mnemonique}</div>
                                          <div class="mobile-card-subtitle">{item.articleName}</div>
                                      </div>
                                      <lightning-button-icon icon-name="utility:delete" variant="bare" alternative-text="Supprimer" title="Supprimer" data-key={item.key} onclick={handleCartRemove}></lightning-button-icon>
                                  </div>
                                  <div class="mobile-card-body">
                                      <p class="slds-text-body_small slds-m-bottom_small">{item.description}</p>
                                      <div class="slds-grid slds-grid_vertical-align-center slds-m-bottom_small">
                                           <label class="slds-col slds-size_1-of-3 slds-text-body_regular">Quantité</label>
                                           <div class="slds-col slds-size_2-of-3">
                                               <lightning-input type="number" variant="label-hidden" value={item.quantity} data-key={item.key} onfocusout={handleMobileQuantityChange} min="1"></lightning-input>
                                           </div>
                                      </div>
                                      <template if:true={item.isAutre}>
                                          <lightning-textarea label="Commentaire" value={item.comment} data-key={item.key} onchange={handleMobileCommentChange} required></lightning-textarea>
                                      </template>
                                  </div>
                                  <!-- Footer removed as per requirement (no status management in mobile) -->
                              </div>
                          </template>
                      </template>
                  </template>
                  <template if:false={cart.length}>
                      <div class="slds-illustration slds-illustration_small" style="text-align: center;">
                          <h3 class="slds-text-heading_small">Le panier est vide</h3>
                          <p class="slds-text-body_regular">Ajoutez des articles depuis la recherche.</p>
                      </div>
                  </template>
              </div>

               <div class="slds-m-top_small slds-text-align_right">
                    <template if:true={showCancelButton}>
                        <lightning-button label="Annuler" variant="destructive" onclick={handleCancel} class="slds-m-right_small"></lightning-button>
                    </template>
                    <lightning-button variant="brand" label={saveButtonLabel} onclick={handleSaveOrder} disabled={isDisabled}></lightning-button>
               </div>
          </div>
      </div>

      <template if:true={loading}><lightning-spinner alternative-text="Chargement..." size="medium"></lightning-spinner></template>
  </lightning-card>
</template>

