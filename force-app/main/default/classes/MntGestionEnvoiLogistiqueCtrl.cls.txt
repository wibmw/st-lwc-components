// force-app/main/default/classes/MntGestionEnvoiLogistiqueCtrl.cls

public without sharing class MntGestionEnvoiLogistiqueCtrl {

    // --- INNER CLASSES (DATA WRAPPERS) ---

    public class CommandeDetailLine {
        @AuraEnabled public Id id;
        @AuraEnabled public String articleName;
        @AuraEnabled public String siteName;
        @AuraEnabled public Decimal quantite;
        @AuraEnabled public String commentaire;
        @AuraEnabled public String typeLigne;
        @AuraEnabled public Id envoiLogistiqueId;
        @AuraEnabled public String statut;
    }

    public class InitialDataWrapper {
        @AuraEnabled public Id nTicketCorrectifId;
        @AuraEnabled public String nTicketName;
        @AuraEnabled public String nTicketSubLabel;
        @AuraEnabled public Id stockId;
        @AuraEnabled public String stockName;
        @AuraEnabled public String stockSubLabel;
        @AuraEnabled public Id destinataireId;
        @AuraEnabled public String destinataireName;
        @AuraEnabled public List<CartLine> lines;
        public InitialDataWrapper() { this.lines = new List<CartLine>(); }
    }

    public class EnvoiDetailsWrapper {
        @AuraEnabled public String envoiName;
        @AuraEnabled public Id nTicketCorrectifId;
        @AuraEnabled public String nTicketName;
        @AuraEnabled public String nTicketSubLabel; 
        @AuraEnabled public String statutDeLEnvoi;
        @AuraEnabled public DateTime dateCreation;
        @AuraEnabled public String createdByName;
        @AuraEnabled public String typeEnvoi;
        @AuraEnabled public Id destinataireId;
        @AuraEnabled public String destinataireName;
        @AuraEnabled public Id stockId;
        @AuraEnabled public String stockName;
        @AuraEnabled public String stockSubLabel;
        @AuraEnabled public String commentaire;
        @AuraEnabled public Boolean isLinkedToCommande;
        @AuraEnabled public Id commandeId;
        @AuraEnabled public List<CartLine> lines;
        public EnvoiDetailsWrapper() { this.lines = new List<CartLine>(); }
    }

    public class PieceUnitaireResult {
        @AuraEnabled public Id id;
        @AuraEnabled public String name;
        @AuraEnabled public String cleEquipement;
        @AuraEnabled public String sousLieu;
        @AuraEnabled public String rma; 
        @AuraEnabled public String mnemonique;
        @AuraEnabled public String description;
    }
    
    public class CartLine {
        @AuraEnabled public Id pieceUnitaireId;
        @AuraEnabled public String name;
        @AuraEnabled public String cleEquipement;
        @AuraEnabled public String sousLieu;
        @AuraEnabled public String numBonLivraison;
        @AuraEnabled public String statutChronopost; 
        @AuraEnabled public String mnemonique;
    }

    public class SaveInputWrapper {
        @AuraEnabled public Id recordId;
        @AuraEnabled public String contextObjectType;
        @AuraEnabled public Id nTicketCorrectifId; 
        @AuraEnabled public String statutDeLEnvoi; 
        @AuraEnabled public String typeEnvoi;
        @AuraEnabled public Id destinataireId;
        @AuraEnabled public Id stockId;
        @AuraEnabled public String commentaire;
        @AuraEnabled public List<CartLine> cart;
        @AuraEnabled public String actionGlobale; 
        @AuraEnabled public Id commandeParenteId; 
        @AuraEnabled public List<CommandeDetailLine> orderLines;
    }

    // --- AURA ENABLED METHODS ---

    // Pour trouver l'ID d'un envoi lié à une commande
    @AuraEnabled(cacheable=true)
    public static Id getEnvoiByCommandeId(Id commandeId) {
        if (commandeId == null) { return null; }
        
        // On suppose qu'une commande n'a qu'un seul envoi. On prend le plus récent.
        List<Envoi_Logistique__c> envois = [
            SELECT Id FROM Envoi_Logistique__c 
            WHERE Commande_Pi_ces__c = :commandeId 
            ORDER BY CreatedDate DESC 
            LIMIT 1
        ];

        return envois.isEmpty() ? null : envois[0].Id;
    }
    
    // Charge les lignes de la commande parente
    @AuraEnabled(cacheable=true)
    public static List<CommandeDetailLine> getCommandeDetails(Id commandeId) {
        List<CommandeDetailLine> results = new List<CommandeDetailLine>();
        for (Commande_Pi_ces_D_tails__c detail : [
            SELECT Code_Articles__r.Name, Lieu__r.Name, Lieu__r.Nom_du_site__c, Quantit__c, Commentaire__c, Type_Ligne__c, Envoi_Logistique__c
            FROM Commande_Pi_ces_D_tails__c
            WHERE Commande_Pi_ces__c = :commandeId
        ]) {
            CommandeDetailLine line = new CommandeDetailLine();
            line.articleName = detail.Code_Articles__r.Name;
            line.siteName = detail.Lieu__r.Name + (String.isNotBlank(detail.Lieu__r.Nom_du_site__c) ? ' - ' + detail.Lieu__r.Nom_du_site__c : '');
            line.quantite = detail.Quantit__c;
            line.commentaire = detail.Commentaire__c;
            line.typeLigne = detail.Type_Ligne__c;
            line.envoiLogistiqueId = detail.Envoi_Logistique__c;
            line.statut = detail.Statut_Commande__c;
            results.add(line);
        }
        return results;
    }

    @AuraEnabled(cacheable=true)
    public static EnvoiDetailsWrapper getEnvoiDetails(Id envoiId) {
        if (envoiId == null) {
            throw new AuraHandledException('L\'ID de l\'envoi est manquant.');
        }

        EnvoiDetailsWrapper result = new EnvoiDetailsWrapper();

        // 1. Récupérer les données de l'en-tête de l'envoi
        Envoi_Logistique__c envoi = [
            SELECT 
                Name, N_Ticket_Correctif__c, N_Ticket_Correctif__r.ID_ticket_client__c, N_Ticket_Correctif__r.Code_site__c, N_Ticket_Correctif__r.Nom_du_site__c, Statut__c, CreatedDate, CreatedBy.Name,
                Type__c, Destinataire__c, Destinataire__r.Name, Stock__c, Stock__r.Name, Stock__r.Nom_du_site__c, Commentaire__c, Commande_Pi_ces__c
            FROM Envoi_Logistique__c 
            WHERE Id = :envoiId 
            LIMIT 1
        ];

        result.envoiName = envoi.Name;
        result.nTicketCorrectifId = envoi.N_Ticket_Correctif__c;
        if (envoi.N_Ticket_Correctif__c != null) {
            result.nTicketName = envoi.N_Ticket_Correctif__r.ID_ticket_client__c;
            String g2r = envoi.N_Ticket_Correctif__r.Code_site__c != null ? envoi.N_Ticket_Correctif__r.Code_site__c : '';
            String siteName = (envoi.N_Ticket_Correctif__r.Nom_du_site__c != null && envoi.N_Ticket_Correctif__r.Nom_du_site__c != null) ? envoi.N_Ticket_Correctif__r.Nom_du_site__c : '';
            result.nTicketSubLabel = g2r + (String.isNotBlank(g2r) && String.isNotBlank(siteName) ? ' - ' : '') + siteName;
        }
        result.statutDeLEnvoi = envoi.Statut__c;
        result.dateCreation = envoi.CreatedDate;
        result.createdByName = envoi.CreatedBy.Name;
        result.typeEnvoi = envoi.Type__c;
        result.destinataireId = envoi.Destinataire__c;
        result.destinataireName = (envoi.Destinataire__r != null) ? envoi.Destinataire__r.Name : '';
        result.stockId = envoi.Stock__c;
        if (envoi.Stock__c != null) {
            result.stockName = envoi.Stock__r.Name;
            result.stockSubLabel = envoi.Stock__r.Nom_du_site__c;
        }
        result.commentaire = envoi.Commentaire__c;

        // On renseigne la nouvelle propriété en fonction du champ de la commande
        result.isLinkedToCommande = (envoi.Commande_Pi_ces__c != null);
        result.commandeId = envoi.Commande_Pi_ces__c;
        result.lines = new List<CartLine>();

        // 2. Récupérer les lignes (pièces) associées via l'historique
        for (Historique_Pi_ces__c hist : [
            SELECT 
                Pi_ce_Unitaire__c, Pi_ce_Unitaire__r.Name, Pi_ce_Unitaire__r.Cl_quipement__c, 
                Pi_ce_Unitaire__r.Sous_Lieux__c, N_Bon_Livraison__c, Statut_Chronopost__c,
                Pi_ce_Unitaire__r.Code_Article__r.Mnemonique__c
            FROM Historique_Pi_ces__c
            WHERE Envoi_Logistique__c = :envoiId
        ]) {
            CartLine line = new CartLine();
            line.pieceUnitaireId = hist.Pi_ce_Unitaire__c;
            line.name = hist.Pi_ce_Unitaire__r.Name;
            line.cleEquipement = hist.Pi_ce_Unitaire__r.Cl_quipement__c;
            line.sousLieu = hist.Pi_ce_Unitaire__r.Sous_Lieux__c;
            line.numBonLivraison = hist.N_Bon_Livraison__c;
            line.statutChronopost = hist.Statut_Chronopost__c;
            line.mnemonique = hist.Pi_ce_Unitaire__r.Code_Article__r.Mnemonique__c;
            result.lines.add(line);
        }

        return result;
    }

    
    // Méthode de recherche générique, essentielle pour l'UI avec Pills
    @AuraEnabled(cacheable=true)
    public static List<IdLabel> searchRecords(String searchTerm, String sObjectType) {
        String queryTerm = '%' + searchTerm + '%';
        String sObjectName = String.escapeSingleQuotes(sObjectType);
        String query;
        
        // --- ÉTAPE 1 : Construction de la chaîne de requête (query) ---
        if (sObjectType == 'Contact') {
            query = 'SELECT Id, Name, MailingStreet, MailingCity, MailingPostalCode FROM Contact WHERE Name LIKE :queryTerm ORDER BY Name LIMIT 10';
        } 
        else if (sObjectType == 'sitetracker__Site__c') {
            query = 'SELECT Id, Name, Nom_du_site__c FROM sitetracker__Site__c WHERE (Name LIKE :queryTerm OR Nom_du_site__c LIKE :queryTerm) ORDER BY Name LIMIT 10';
        } 
        else if (sObjectType == 'Correctif__c') {
            query = 'SELECT Id, ID_ticket_client__c, Code_site__c, Nom_du_site__c FROM Correctif__c WHERE ID_ticket_client__c LIKE :queryTerm OR Code_site__c LIKE :queryTerm ORDER BY ID_ticket_client__c, Code_site__c LIMIT 10';
        }
        // Cas par défaut pour tout autre objet
        else {
            query = 'SELECT Id, Name FROM ' + sObjectName + ' WHERE Name LIKE :queryTerm ORDER BY Name LIMIT 10';
        }

        // --- ÉTAPE 2 : Exécution de la requête et traitement des résultats ---
        List<IdLabel> results = new List<IdLabel>();
        for (SObject record : Database.query(query)) {
            IdLabel il = new IdLabel();
            il.value = (Id)record.get('Id');
            
            // Logique de traitement spécifique à chaque type d'objet
            if (sObjectType == 'Contact') {
                il.label = (String)record.get('Name');
                List<String> addressParts = new List<String>();
                if (String.isNotBlank((String)record.get('MailingStreet'))) addressParts.add((String)record.get('MailingStreet'));
                if (String.isNotBlank((String)record.get('MailingPostalCode'))) addressParts.add((String)record.get('MailingPostalCode'));
                if (String.isNotBlank((String)record.get('MailingCity'))) addressParts.add((String)record.get('MailingCity'));
                il.sublabel = String.join(addressParts, ', ');
            }
            else if (sObjectType == 'sitetracker__Site__c') {
                il.label = (String)record.get('Name');
                il.sublabel = (String)record.get('Nom_du_site__c');
            }
            else if (sObjectType == 'Correctif__c') {
                il.label = (String)record.get('ID_ticket_client__c');
                String g2r = (String)record.get('Code_site__c');
                String siteName = (String)record.get('Nom_du_site__c');
                il.sublabel = (g2r != null ? g2r : '') + (String.isNotBlank(g2r) && String.isNotBlank(siteName) ? ' - ' : '') + siteName;
            }
            else {
                il.label = (String)record.get('Name');
            }
            
            results.add(il);
        }
        
        return results;
    }
    
    @AuraEnabled(cacheable=true)
    public static InitialDataWrapper getInitialData(Id recordId, String sObjectType) {
        InitialDataWrapper data = new InitialDataWrapper();
        if (sObjectType == 'Commande_Pi_ces__c' && recordId != null) {
            List<Commande_Pi_ces__c> commandes = [
                SELECT N_Ticket_Correctif__c, N_Ticket_Correctif__r.ID_ticket_client__c, N_Ticket_Correctif__r.G2R__c, N_Ticket_Correctif__r.Site__r.Name, Lieu__c, Lieu__r.Name, Lieu__r.Nom_du_site__c, Adresse_de_Livraison__c, Adresse_de_Livraison__r.Name
                FROM Commande_Pi_ces__c
                WHERE Id = :recordId
                LIMIT 1
            ];
            if (!commandes.isEmpty()) {
                Commande_Pi_ces__c cmd = commandes[0];
                data.nTicketCorrectifId = cmd.N_Ticket_Correctif__c;
                data.nTicketName = (cmd.N_Ticket_Correctif__r != null) ? cmd.N_Ticket_Correctif__r.ID_ticket_client__c : '';
                if (cmd.N_Ticket_Correctif__r != null) {
                    String g2r = cmd.N_Ticket_Correctif__r.Code_site__c != null ? cmd.N_Ticket_Correctif__r.Code_site__c : '';
                    String siteName = (cmd.N_Ticket_Correctif__r.Nom_du_site__c != null) ? cmd.N_Ticket_Correctif__r.Nom_du_site__c : '';
                    data.nTicketSubLabel = g2r + (String.isNotBlank(g2r) && String.isNotBlank(siteName) ? ' - ' : '') + siteName;
                }
            
                if (cmd.Lieu__c != null) {
                    data.stockId = cmd.Lieu__c; 
                    data.stockName = cmd.Lieu__r.Name;
                    data.stockSubLabel = cmd.Lieu__r.Nom_du_site__c;
                }

                data.destinataireId = cmd.Adresse_de_Livraison__c;
                data.destinataireName = (cmd.Adresse_de_Livraison__r != null) ? cmd.Adresse_de_Livraison__r.Name : '';
            }
        }
        return data;
    }

    @AuraEnabled(cacheable=true)
    public static List<PieceUnitaireResult> searchPiecesUnitaires(String searchTerm, String typeEnvoi) {
        String queryTerm = '%' + searchTerm + '%';
        Id currentUserId = UserInfo.getUserId();
        List<PieceUnitaireResult> results = new List<PieceUnitaireResult>();

        // Logique de filtrage dynamique sur le statut
        String statutAFiltrer = 'Réparateur'.equals(typeEnvoi) ? 'A Envoyer en REP' : 'En Stock';
        
        // La requête inclut maintenant RMA__c et filtre sur le statut dynamique
        for(Pi_ce_Unitaire__c piece : [
            SELECT Id, Name, Cl_quipement__c, Sous_Lieux__c, RMA__c, Code_Article__r.Mnemonique__c, Code_Article__r.Description__c
            FROM Pi_ce_Unitaire__c
            WHERE (Name LIKE :queryTerm OR Cl_quipement__c LIKE :queryTerm OR Code_Article__r.Mnemonique__c LIKE :queryTerm)
              AND Statut__c = :statutAFiltrer
              AND Lieu__r.Logisticien__c = :currentUserId
            LIMIT 50
        ]) {
            PieceUnitaireResult res = new PieceUnitaireResult();
            res.id = piece.Id;
            res.name = piece.Name;
            res.cleEquipement = piece.Cl_quipement__c;
            res.sousLieu = piece.Sous_Lieux__c;
            res.rma = piece.RMA__c; 
            res.mnemonique = piece.Code_Article__r != null ? piece.Code_Article__r.Mnemonique__c : '';
            res.description = piece.Code_Article__r != null ? piece.Code_Article__r.Description__c : '';
            results.add(res);
        }
        return results;
    }
    @AuraEnabled
    public static Id saveEnvoi(String inputJSON) {
        try {
            SaveInputWrapper input = (SaveInputWrapper) JSON.deserialize(inputJSON, SaveInputWrapper.class);
            
            // 1. Initialisation Envoi
            Envoi_Logistique__c envoi;
            Boolean isCreation = false;
            if (input.recordId != null && 'Envoi_Logistique__c'.equals(input.contextObjectType)) {
                envoi = new Envoi_Logistique__c(Id = input.recordId);
            } else {
                envoi = new Envoi_Logistique__c();
                isCreation = true;
                if ('Commande_Pi_ces__c'.equals(input.contextObjectType)) {
                    envoi.Commande_Pi_ces__c = input.recordId;
                }
            }
            
            envoi.N_Ticket_Correctif__c = input.nTicketCorrectifId;
            envoi.Type__c = input.typeEnvoi; 
            envoi.Destinataire__c = input.destinataireId; 
            envoi.Stock__c = input.stockId; 
            envoi.Commentaire__c = input.commentaire;
            
            // --- CORRECTION "Duplicate variable" : Renommage en idCommandeParente ---
            Id idCommandeParente = (envoi.Commande_Pi_ces__c != null) ? envoi.Commande_Pi_ces__c : input.commandeParenteId;
            List<SObject> recordsToUpdate = new List<SObject>();

            // Cas 1 : REFUSER LA COMMANDE
            if (input.actionGlobale == 'REFUSER') {
                envoi.Statut_de_l_Envoi__c = 'Clôturé NOK';
                
                if (idCommandeParente != null) {
                    recordsToUpdate.add(new Commande_Pi_ces__c(Id = idCommandeParente, Statut_Commande__c = 'A Retraiter'));
                }
            } 
            // Cas 2 : VALIDER LA COMMANDE
            else if (input.actionGlobale == 'VALIDER') {
                envoi.Statut_de_l_Envoi__c = 'Livraison en Cours';
                
                if (idCommandeParente != null) {
                    recordsToUpdate.add(new Commande_Pi_ces__c(Id = idCommandeParente, Statut_Commande__c = 'Commande en Cours'));
                }
            } 
            else if (isCreation) {
                envoi.Statut_de_l_Envoi__c = 'Commande à traiter';
            }
            
            upsert envoi;

            if (!recordsToUpdate.isEmpty()) {
                update recordsToUpdate;
            }

            // --- CORRECTION "Variable does not exist: id" ---
            // Le champ .id existe maintenant car ajouté dans le Wrapper CommandeDetailLine ci-dessus
            if (input.orderLines != null && !input.orderLines.isEmpty()) {
                List<Commande_Pi_ces_D_tails__c> detailsToUpdate = new List<Commande_Pi_ces_D_tails__c>();
                for (CommandeDetailLine lineWrapper : input.orderLines) {
                    if (lineWrapper.id != null) {
                        detailsToUpdate.add(new Commande_Pi_ces_D_tails__c(
                            Id = lineWrapper.id,
                            Statut_Commande__c = lineWrapper.statut
                        ));
                    }
                }
                if (!detailsToUpdate.isEmpty()) {
                    update detailsToUpdate;
                }
            }

            // 2. Gestion des lignes (Historique_Pi_ces__c) - Code inchangé
            Envoi_Logistique__c fullEnvoi = [
                SELECT Id, Destinataire__r.Name, Stock__r.Name, 
                       N_Ticket_Correctif__c, N_Ticket_Correctif__r.Name, N_Ticket_Correctif__r.Code_site__c 
                FROM Envoi_Logistique__c 
                WHERE Id = :envoi.Id
            ];
            
            Set<Id> currentPieceIdsInCart = new Set<Id>();
            Map<Id, CartLine> cartLineMap = new Map<Id, CartLine>();
            for (CartLine line : input.cart) { currentPieceIdsInCart.add(line.pieceUnitaireId); cartLineMap.put(line.pieceUnitaireId, line); }
            
            Map<Id, Historique_Pi_ces__c> previousHistoriesMap = new Map<Id, Historique_Pi_ces__c>();
            for (Historique_Pi_ces__c hist : [SELECT Id, Pi_ce_Unitaire__c, N_Bon_Livraison__c, Statut_Commande_Pi_ce__c FROM Historique_Pi_ces__c WHERE Envoi_Logistique__c = :envoi.Id]) {
                previousHistoriesMap.put(hist.Pi_ce_Unitaire__c, hist);
            }
            
            List<Historique_Pi_ces__c> historiesToDelete = new List<Historique_Pi_ces__c>();
            List<Historique_Pi_ces__c> historiesToCreate = new List<Historique_Pi_ces__c>();
            List<Historique_Pi_ces__c> historiesToUpdate = new List<Historique_Pi_ces__c>();
            List<Pi_ce_Unitaire__c> piecesToUpdate = new List<Pi_ce_Unitaire__c>();
    
            // Logique SUPPRESSION
            Set<Id> removedPieceIds = new Set<Id>(previousHistoriesMap.keySet());
            removedPieceIds.removeAll(currentPieceIdsInCart);

            if (!removedPieceIds.isEmpty()) {
                Map<Id, Pi_ce_Unitaire__c> removedPiecesData = new Map<Id, Pi_ce_Unitaire__c>([
                    SELECT Id, Lieu_Pr_c_dent__c FROM Pi_ce_Unitaire__c WHERE Id IN :removedPieceIds
                ]);
                for (Id pieceId : removedPieceIds) {
                    historiesToDelete.add(previousHistoriesMap.get(pieceId));
                    Pi_ce_Unitaire__c pieceToRestore = removedPiecesData.get(pieceId);
                    piecesToUpdate.add(new Pi_ce_Unitaire__c(
                        Id = pieceId,
                        Statut__c = 'En Stock',
                        Lieu__c = pieceToRestore.Lieu_Pr_c_dent__c, 
                        Lieu_Pr_c_dent__c = null
                    ));
                }
            }
            
            // Logique CRÉATION / UPDATE
            String newStatusForSentPieces = 'Réparateur'.equals(input.typeEnvoi) ? 'En Réparation' : 'A Réceptionner';
            Map<Id, Pi_ce_Unitaire__c> piecesDataMap = new Map<Id, Pi_ce_Unitaire__c>([SELECT Id, Name, Lieu__c, Lieu__r.Name, RMA__c  FROM Pi_ce_Unitaire__c WHERE Id IN :currentPieceIdsInCart]);
            String today = Date.today().format();
    
            for (Id currentPieceId : currentPieceIdsInCart) {
                CartLine line = cartLineMap.get(currentPieceId);
                Pi_ce_Unitaire__c pieceActuelle = piecesDataMap.get(currentPieceId);
                
                if (!previousHistoriesMap.containsKey(currentPieceId)) {
                    Historique_Pi_ces__c hist = new Historique_Pi_ces__c();
                    hist.Envoi_Logistique__c = envoi.Id;
                    hist.Pi_ce_Unitaire__c = pieceActuelle.Id;
                    hist.N_Bon_Livraison__c = line.numBonLivraison;
                    hist.Statut_Commande_Pi_ce__c = line.statutChronopost;
                    hist.Statut__c = newStatusForSentPieces;
                    hist.Type__c = 'ENV';
                    hist.Lieu__c = input.stockId;
                    hist.TRAME__c = '[TRIGRAMME][PANNE][EQT_MIS_SUR_SITE_(SN) = N° de série de la pièce INSTALLE][RMA=N° RMA][CONTRAT PROMA FIXE/MOBILE]';
                    
                    String toLocation = (fullEnvoi.Stock__r != null ? fullEnvoi.Stock__r.Name : '');

                    if ('Réparateur'.equals(input.typeEnvoi)) {
                        hist.Remarques__c = 'Envois le [' + today + '] RMA N° [' + (pieceActuelle.RMA__c != null ? pieceActuelle.RMA__c : '') + '] N° de BL [' + line.numBonLivraison + ']';
                        hist.BT_RPMAT__c = true;
                    } 
                    else {
                        hist.INVENTAI__c = true;
                        hist.Lieu__c = input.stockId;

                        if (fullEnvoi.N_Ticket_Correctif__c == null) {
                            hist.Remarques__c = 'Envois le [' + today + '] vers [' + toLocation + '] N° de BL [' + line.numBonLivraison + ']';
                        } 
                        else {
                            String fromLocation = (pieceActuelle.Lieu__r != null ? pieceActuelle.Lieu__r.Name : '');
                            String ticketNum = (fullEnvoi.N_Ticket_Correctif__r != null ? fullEnvoi.N_Ticket_Correctif__r.Name : '');
                            String siteCode = (fullEnvoi.N_Ticket_Correctif__r != null ? fullEnvoi.N_Ticket_Correctif__r.Code_site__c : '');
                            
                            hist.Remarques__c = 'Envois depuis [' + fromLocation + '] vers [' + toLocation + '] N° de BL [' + line.numBonLivraison + '] N° Ticket [' + ticketNum + '] Site Code [' + siteCode + '] le [' + today + ']';
                        }
                    }
                    historiesToCreate.add(hist);
                } else {
                    Historique_Pi_ces__c existingHist = previousHistoriesMap.get(currentPieceId);
                    Boolean needsUpdate = false;
                    
                    if (existingHist.N_Bon_Livraison__c != line.numBonLivraison) {
                        existingHist.N_Bon_Livraison__c = line.numBonLivraison;
                        needsUpdate = true;
                    }
                    if (existingHist.Statut_Commande_Pi_ce__c != line.statutChronopost) {
                        existingHist.Statut_Commande_Pi_ce__c = line.statutChronopost;
                        needsUpdate = true;
                    }

                    if(needsUpdate) {
                        historiesToUpdate.add(existingHist);
                    }
                }
    
                Pi_ce_Unitaire__c pieceToUpdate = new Pi_ce_Unitaire__c(Id = pieceActuelle.Id, Statut__c = newStatusForSentPieces);
                pieceToUpdate.Lieu_Pr_c_dent__c = pieceActuelle.Lieu__c;
                pieceToUpdate.Lieu__c = input.stockId;
                piecesToUpdate.add(pieceToUpdate);
            }
    
            if (!historiesToDelete.isEmpty()) { delete historiesToDelete; }
            if (!historiesToCreate.isEmpty()) { insert historiesToCreate; }
            if (!historiesToUpdate.isEmpty()) { update historiesToUpdate; }
            if (!piecesToUpdate.isEmpty()) { update piecesToUpdate; }
            
            return envoi.Id;
    
        } catch (Exception e) {
            throw new AuraHandledException(e.getMessage() + ' at line ' + e.getLineNumber());
        }
    }

    // Classe wrapper utilitaire pour la méthode searchRecords
    public class IdLabel {
        @AuraEnabled public String value;
        @AuraEnabled public String label;
        @AuraEnabled public String sublabel;
    }
}